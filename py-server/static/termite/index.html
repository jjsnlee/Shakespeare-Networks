<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Shakespare | Termite | Topic Model Visualization</title>
	<link rel="stylesheet" type="text/css" href="termite.css" />
	<link rel="stylesheet" type="text/css" href="InteractionObjects.css" />
	
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
	
	<script type="text/javascript" src="/static/lib/ext/angular-1.2.9/angular.js"></script>
	
	<script type="text/javascript" src="/static/lib/ang-dnd.js"></script>
  <!--<script type="text/javascript" src="/static/lib/ext/ui-utils.min.js"></script>-->

	<script type="text/javascript" src="AngShowDocs.js"></script>

	<script type="text/javascript" src="/static/lib/ext/underscore-min-1.5.0.js"></script>
	<script type="text/javascript" src="/static/lib/ext/backbone.min.js"></script>
	<script type="text/javascript" src="/static/lib/ext/d3.v3.min.js"></script> 
	<script type="text/javascript" src="/static/lib/ext/html5slider.min.js"></script>

	<script type="text/javascript" src="SeriatedTermTopicProbabilityModel.js"></script>
	<script type="text/javascript" src="FilteredTermTopicProbabilityModel.js"></script>
	<script type="text/javascript" src="TermFrequencyModel.js"></script>
	<script type="text/javascript" src="ViewParameters.js"></script>
	<script type="text/javascript" src="TermTopicMatrixView.js"></script>
	<script type="text/javascript" src="TermFrequencyView.js"></script>
	<script type="text/javascript" src="UserControlViews.js"></script>
	<script type="text/javascript" src="StateModel.js"></script>
	<script type="text/javascript" src="QueryString.js"></script>

<script type="text/javascript">

termiteTopics.controller('msgCtrl', function($scope, $window, termiteMsgService) {

  var stateModel, seriatedTermTopicProbM, filteredTermTopicProbM, termFrequencyModel;  

  function loadPage(ldaModel) {
    // create backbone models and views
    stateModel = new StateModel();
    var termTopicMatrixView = new TermTopicMatrixView( {el:"div.termTopicMatrixContainer"} );
    var termFrequencyView = new TermFrequencyView( {el:"div.termFrequencyContainer"} );
  
    // Almost absolutely nothing here atm...  
    seriatedTermTopicProbM = new SeriatedTermTopicProbabilityModel();
    // Model for the termTopicMatrixView
    filteredTermTopicProbM = new FilteredTermTopicProbabilityModel();
    // Model for the term frequency column
    termFrequencyModel = new TermFrequencyModel();  

	  // init user control views
    var totalTermsView = new TotalTermsView( {model: stateModel} );
    var affinityNumTermsView = new AffinityNumTermsView( {model: stateModel} );
    var salientNumTermsView = new SalientNumTermsView( {model: stateModel} );
    var foundTermsView = new FoundTermsView( {model: stateModel} );
    var unfoundTermsView = new UnfoundTermsView( {model: stateModel} );

    initUserControlViewComponents(stateModel);

    var basedir = '../data/'+ldaModel
    seriatedTermTopicProbM.url = basedir+"/seriated-parameters.json";
    filteredTermTopicProbM.url = basedir+"/filtered-parameters.json";
    termFrequencyModel.url = basedir+"/global-term-freqs.json";

    // Pretty msure don't need this seriatedTermTopicProbM, the termFrequencyModel
    // should pretty much have the same data...
    //seriatedTermTopicProbM.initModel( fullModel );	// unused at the moment

    filteredTermTopicProbM.initModel( seriatedTermTopicProbM, stateModel );
    //filteredTermTopicProbM.initModel( termFrequencyModel, stateModel );
    termTopicMatrixView.initModel( filteredTermTopicProbM );

    termFrequencyModel.initModels( filteredTermTopicProbM, stateModel );
    termFrequencyView.initModel( termFrequencyModel );

    // load states from QueryString and save changes to state to query string
    stateModel.on( "change", stateModel.saveStatesToQueryString, stateModel );
    
    // load all models
    stateModel.once( "loaded:states", seriatedTermTopicProbM.load, seriatedTermTopicProbM );
    //stateModel.once( "loaded:states", filteredTermTopicProbM.load, filteredTermTopicProbM );
    seriatedTermTopicProbM.once( "loaded:seriated", filteredTermTopicProbM.load, filteredTermTopicProbM );
    filteredTermTopicProbM.once( "loaded:filtered", termTopicMatrixView.load, termTopicMatrixView );
    filteredTermTopicProbM.once( "loaded:filtered", termFrequencyModel.load, termFrequencyModel );
    termFrequencyModel.once( "loaded:freqModel", termFrequencyView.load, termFrequencyView );
    stateModel.once("sending:colors", termTopicMatrixView.receiveSelectedTopics, termTopicMatrixView);

    // initialize all events that listen to stateModel
    stateModel.once( "loaded:states", function() {	
      filteredTermTopicProbM.listenTo(stateModel, "change:numAffinityTerms", filteredTermTopicProbM.update.bind( filteredTermTopicProbM ));
      filteredTermTopicProbM.listenTo(stateModel, "change:numSalientTerms", filteredTermTopicProbM.update.bind( filteredTermTopicProbM ));
      filteredTermTopicProbM.listenTo(stateModel, "change:visibleTerms", filteredTermTopicProbM.update.bind( filteredTermTopicProbM ));
      filteredTermTopicProbM.listenTo(stateModel, "change:sortType change:doubleClickTopic", filteredTermTopicProbM.update.bind( filteredTermTopicProbM));
      filteredTermTopicProbM.listenTo(stateModel, "change:addTopTwenty", filteredTermTopicProbM.update.bind( filteredTermTopicProbM ));
      
      foundTermsView.listenTo(   stateModel, 'change:foundTerms',   foundTermsView.render );
      unfoundTermsView.listenTo( stateModel, 'change:unfoundTerms', unfoundTermsView.render );
      
      termTopicMatrixView.listenTo(stateModel, "change:highlightedTerm", termTopicMatrixView.onSelectionTermChanged, termTopicMatrixView );
      termTopicMatrixView.listenTo(stateModel, "change:highlightedTopic", termTopicMatrixView.onSelectionTopicChanged, termTopicMatrixView );
      
      termFrequencyView.listenTo(stateModel, "change:highlightedTerm", termFrequencyView.onHighlightTermChanged, termFrequencyView);
      termFrequencyView.listenTo(stateModel, "change:highlightedTopic", termFrequencyView.onHighlightTopicChanged, termFrequencyView);
      
      termTopicMatrixView.listenTo( stateModel, "color:topic", termTopicMatrixView.clickTopic, termTopicMatrixView);
      filteredTermTopicProbM.listenTo( stateModel, "color:topic", filteredTermTopicProbM.selectTopic, filteredTermTopicProbM);
      termFrequencyModel.listenTo( stateModel, "color:topic", termFrequencyModel.selectTopic, termFrequencyModel);
      //sortDescription.listenTo( stateModel, "change:sortType change:doubleClickTopic" , sortDescription.render );
    });

    // initialize all events that listen to filtered model
    filteredTermTopicProbM.once( "loaded:filtered", function() {
      // Declare dependencies
      // data pipeline events
      termFrequencyModel.listenTo( filteredTermTopicProbM, "change:termIndex", termFrequencyModel.update.bind( termFrequencyModel ));
      termTopicMatrixView.listenTo( filteredTermTopicProbM, "change:sparseMatrix", termTopicMatrixView.update.bind( termTopicMatrixView ));
      totalTermsView.listenTo( filteredTermTopicProbM, 'change:termIndex', totalTermsView.render );
    
      // Once the matrix has loaded, need to set the top level div to a fixed size,
      // and then can set the inner one to be wider, which the scrollbar 
      $(".wrapper1").width($(".wrapper1").width());
      $(".div1").width($(".termTopicMatrixContainer").children().width());
    });

    // initialize all events that listen to term frequency model
    termFrequencyModel.once( "loaded:freqModel", function() {
      termFrequencyView.listenTo( termFrequencyModel, "change:topicalFreqMatrix", termFrequencyView.renderUpdate, termFrequencyView);
      termFrequencyView.listenTo( termFrequencyModel, "change:termIndex", termFrequencyView.renderUpdate.bind( termFrequencyView ));
    });

    // initialize user controls listeners that catch state model changes
    affinityNumTermsView.listenTo( stateModel, 'change:numAffinityTerms', affinityNumTermsView.render );
    salientNumTermsView.listenTo( stateModel, 'change:numSalientTerms', salientNumTermsView.render );
    totalTermsView.listenTo( stateModel, 'change:totalTerms', totalTermsView.render );

    // initialize state model listeners that catch view events
    stateModel.listenTo( termTopicMatrixView, "mouseover:topic mouseout:topic", stateModel.setHighlightedTopic );
    stateModel.listenTo( termTopicMatrixView, "mouseover:term mouseout:term", stateModel.setHighlightedTerm );
    stateModel.listenTo( termFrequencyView,   "mouseover:term mouseout:term", stateModel.setHighlightedTerm );
    //stateModel.listenTo( termTopicMatrixView, "doubleClick:topic", stateModel.setDoubleClickTopic );
    //stateModel.listenTo( termTopicMatrixView, "click:topic", stateModel.selectTopic );

    // http://backbonejs.org/#Events-listenTo: object.listenTo(other, event, callback)
    stateModel.listenTo( termTopicMatrixView, "click:topic", function(topicIndex) {
      console.log('[click:topic] topicIndex: '+topicIndex+', highlightedTopic: '+stateModel.get('highlightedTopic'));
      stateModel.selectTopic(topicIndex);
      //console.log( termTopicMatrixView.parentModel );
      // We could be clicking OFF a topic 
      if(stateModel.get('highlightedTopic') == topicIndex) {
        stateModel.setDoubleClickTopic(topicIndex);
        var topicLabel = termTopicMatrixView.parentModel.attributes.topicIndex[topicIndex];
        //var terms = filteredTermTopicProbM.termIndex;
        termiteMsgService.setTopic(ldaModel, topicIndex, topicLabel);
      }
    });
    // being loading process
    stateModel.loadStatesFromQueryString();
    initColorObjects(null);
  }
  
  $scope.getModels = function() {
    return {
      stateModel : stateModel, 
      //seriatedTermTopicProbabilityModel : seriatedTermTopicProbM, 
      filteredTermTopicProbabilityModel : filteredTermTopicProbM,
      termFrequencyModel : termFrequencyModel 
    };
  };

  // initialize parent and state model where needed
  //var basedir = '../data/';
  //var LdaModel = 'shakespeare-20';
  //var LdaModel = 'shakespeare-char-scene-20';
  $scope.LDAModels = [
    'shakespeare-char-scene-100',
    'shakespeare-char-scene-100-test',
    'shakespeare-50',
  ];
  $scope.LDAModel = $scope.LDAModels[1];
  $scope.changeModel = function() {
    console.log('$scope.LDAModel: '+$scope.LDAModel);
    //loadPage($scope.LDAModel);
    //var urlRoot = '/'+$scope.LDAModel;
    //$window.location.href = urlRoot;
    //console.log('$window.location.href: '+$window.location.href);
  };
  loadPage($scope.LDAModel);
   
});

$(function(){
  $(".wrapper1").scroll(function(){
    $(".wrapper2").scrollLeft($(".wrapper1").scrollLeft());
  });
  $(".wrapper2").scroll(function(){
    $(".wrapper1").scrollLeft($(".wrapper2").scrollLeft());
  });
});
</script>

</head>
<body ng-app="termiteTopicDisplay" !onLoad="onLoad()">
<div id="pageBackground" ng-controller="msgCtrl">
  <div id="pageFrame">

    <div id="pageHeader">
      <div id="pageControl" class="headerObject">

        <!--<div ng-include="'termite-hdr.html'" onLoad="onLoad()"></div>-->
    <table cellspacing="5">
    <tr>
      <td style="vertical-align: top">
        <select name="LDAModel" ng-model="LDAModel"
          ng-options="m for m in LDAModels" 
          ng-change="changeModel()" style="width:200px">
        </select>
      </td>
    
      <td style="vertical-align: top">
        <div class="line">
            Currently showing 
            <div class="TotalTermsView" style="display:inline">25</div> 
            total terms.
        </div>
        <div class="line">
            Show top:
            <input class="AffinityNumTermsSlider" style="display:inline; width: 140px; vertical-align: -5px;" type="range" max="100" min="10" value="25"/> 
            <div class="AffinityNumTermsView" style="display:inline">25</div> 
            terms by affinity.</div>
        <div class="line">
            Show top:
            <input class="SalientNumTermsSlider" style="display:inline; width: 140px; vertical-align: -5px;" type="range" max="100" min="0" value="0"/>
            <div class="SalientNumTermsView" style="display:inline-block">0</div> 
            terms by saliency.
        </div>
      </td>
      
      <td style="vertical-align: top">
            <div class="line">
                Add top terms for clicked topics
                <input type="checkbox" class="TopTwentyAddition" style="display:inline-block"></div> 
            </div>
            <div class="line">
                Always showing terms: 
                <input class="UserDefinedTermsBox" style="display:inline; width: 200px; vertical-align: -2px" type="text"/>
                <div class="FoundTermsView" style="display:inline-block"></div>
            </div>
            <div class="line">
                <div class="UnfoundTermsPrefix" style="display:inline-block; visibility:hidden">Cannot find these terms: </div>
                <div class="UnfoundTermsView" style="display:inline-block; visibility:hidden"></div>
            </div>
        </td>
        <td style="vertical-align: top">
            <div class="line">
                <button type="button" class="clearAll" style="width: 150px">Clear all topic selections</button>
            </div>
            <div class="line">
                <button type="button" class="clearSort" style="width: 150px">Clear sorting method</button>
            </div>
        </td>
      </tr>
    </table>

      </div>
    </div>

<style>
.wrapper1, .wrapper2 {
  overflow-x:scroll;
  overflow-y:hidden;
}
.wrapper1 { 
  height: 20px; 
}
.div1 {
  width:100%;
  height:20px;
}
.popupDiv { 
  width:40%; height:80%; position:absolute; 
  top:10%; left:30%; 
  border:3px solid #eee; background: white; 
  overflow:hidden; 
  padding:0px 0px 10px; 
}
.charText {
  color: #666; font-family: Verdana; font-size: 8pt;padding:10px 5px 10px;
}
.person { 
  background-color:#b0c4de; 
}
.organization { 
  background-color:red; 
}
.yellow {
  background-color:yellow; 
}
</style>

    <div id="pageContent" ng-controller="contentCtrl">
      <table border=1 cellpadding=1 cellspacing=1 width="100%">
      <tr>
        <td></td>
        <td>
          <div class="wrapper1">
            <div class="div1"></div>
          </div>
        </td>
        <td></td>
      </tr>
	    <tr>
	      <!-- Frequent terms -->
	      <td width="20%" style="vertical-align: top">
	        <div class="termFrequencyContainer"></div>
	      </td>
	      <!-- Main matrix -->
	      <td width="50%" style="vertical-align:top;">
          <div class="wrapper2" style="width:600px;">
            <!-- !style="width:100%;overflow:auto;" -->
	          <div class="termTopicMatrixContainer"></div>
	        </div>
	      </td>
	      <!-- Related documents -->
	      <td width="30%" style="vertical-align: top" ng-cloak>
        <div ng-show="topDocsForTopic">
          <span style="color: #666; font-family: Verdana; font-size: 8pt;">
            {{selectedTopic}}
          </span>
          <table border=1 cellpadding=1 cellspacing=0 width=250>
            <tr ng-repeat="doc in topDocsForTopic" style="color:#666; font-family:Verdana; font-size:8pt;">
              <td><a href="" ng-click="getDocContent(doc.char)">{{doc.char}}</a></td>
              <td>{{doc.score}}</td>
            </tr>
          </table>
        </div>
	      </td>
	    </tr>
      </table>

      <div my-draggable id="topicPopup" ng-show="showTopicDetails===1" class="popupDiv">
        <div style="position:absolute;width:90%;padding:5px 30px 10px;">
          <div align="right">
            <button ng-click="showTopicDetails=0">Close</button>
          </div>
          <div align="top">{{docName}}</div>
        </div>
        <div style="position:relative;top:8%;width:100%;height:600px;overflow:auto;">
          <div ng-bind-html="docContent"></div>
        </div>
      </div> <!-- END TopicPopup -->

    </div> <!-- END PageContent, CONTROLLER: contentCtrl-->

	  <div id="pageDetails">
	    <p>This visualization shows the topical distribution of words in a corpus.</p>
	    <p>The area of a circle is proportional to a word's frequency in a topic.</p>
	  </div>

    <div id="pageFooter">
      Termite | Topic Model Visualization
      <br/>
      <span class="credits">
        Visualization by Jason Chuang, Ashley Jin, Stanford Vis Group
      </span>
      <br/>
      http://termite.stanford.edu | Version 1.1
    </div>
  </div>
</div>

<!--<style>
  #draggable { width: 150px; height: 150px; padding: 0.5em; }
</style>
<div id="draggable" class="ui-widget-content">
  <p>Drag me around</p>
</div>-->

</body>
</html>
