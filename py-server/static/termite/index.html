<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Shakespare | Termite | Topic Model Visualization</title>
	<link rel="stylesheet" type="text/css" href="termite.css" />
	<link rel="stylesheet" type="text/css" href="InteractionObjects.css" />
	
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
	
	<script type="text/javascript" src="/static/lib/ext/angular-1.2.9/angular.js"></script>
	
	<script type="text/javascript" src="/static/lib/ang-dnd.js"></script>
  <!--<script type="text/javascript" src="/static/lib/ext/ui-utils.min.js"></script>-->

	<script type="text/javascript" src="AngShowDocs.js"></script>

	<script type="text/javascript" src="/static/lib/ext/underscore-min-1.5.0.js"></script>
	<script type="text/javascript" src="/static/lib/ext/backbone.min.js"></script>
	<script type="text/javascript" src="/static/lib/ext/d3.v3.min.js"></script> 
	<script type="text/javascript" src="/static/lib/ext/html5slider.min.js"></script>

	<script type="text/javascript" src="SeriatedTermTopicProbabilityModel.js"></script>
	<script type="text/javascript" src="TermTopicProbabilityModel.js"></script>
	<script type="text/javascript" src="TermFrequencyModel.js"></script>
	<script type="text/javascript" src="ViewParameters.js"></script>
	<script type="text/javascript" src="TermTopicMatrixView.js"></script>
	<script type="text/javascript" src="TermFrequencyView.js"></script>
	<script type="text/javascript" src="UserControlViews.js"></script>
	<script type="text/javascript" src="StateModel.js"></script>
	<script type="text/javascript" src="QueryString.js"></script>

<script type="text/javascript">

termiteTopics.controller('msgCtrl', function($scope, $window, termiteMsgService) {

  var stateModel, seriatedTermTopicProbM, termTopicProbM, termFrequencyModel;  

  function loadPage(ldaModel) {
    // create backbone models and views
    stateModel = new StateModel();
    var termTopicMatrixView = new TermTopicMatrixView( {el:"div.termTopicMatrixContainer"} );
    var termFrequencyView = new TermFrequencyView( {el:"div.termFrequencyContainer"} );
  
    // Almost absolutely nothing here atm...  
    seriatedTermTopicProbM = new SeriatedTermTopicProbabilityModel();
    // Model for the termTopicMatrixView
    termTopicProbM = new TermTopicProbabilityModel();
    // Model for the term frequency column
    termFrequencyModel = new TermFrequencyModel();  

	  // init user control views
    var totalTermsView = new TotalTermsView( {model: stateModel} );
    var affinityNumTermsView = new AffinityNumTermsView( {model: stateModel} );
    var salientNumTermsView = new SalientNumTermsView( {model: stateModel} );
    var foundTermsView = new FoundTermsView( {model: stateModel} );
    var unfoundTermsView = new UnfoundTermsView( {model: stateModel} );

    initUserControlViewComponents(stateModel);

    var basedir = '/static/data/'+ldaModel
    seriatedTermTopicProbM.url = basedir+"/seriated-parameters.json";
    termTopicProbM.url = basedir+"/filtered-parameters.json";
    termFrequencyModel.url = basedir+"/global-term-freqs.json";

    // Pretty msure don't need this seriatedTermTopicProbM, the termFrequencyModel
    // should pretty much have the same data...
    //seriatedTermTopicProbM.initModel( fullModel );	// unused at the moment

    termTopicProbM.initModel( seriatedTermTopicProbM, stateModel );
    //termTopicProbM.initModel( termFrequencyModel, stateModel );
    termTopicMatrixView.initModel( termTopicProbM );

    termFrequencyModel.initModels( termTopicProbM, stateModel );
    termFrequencyView.initModel( termFrequencyModel );

    // load states from QueryString and save changes to state to query string
    stateModel.on( "change", stateModel.saveStatesToQueryString, stateModel );
    
    // load all models
    stateModel.once( "loaded:states", seriatedTermTopicProbM.load, seriatedTermTopicProbM );
    //stateModel.once( "loaded:states", termTopicProbM.load, termTopicProbM );
    seriatedTermTopicProbM.once( "loaded:seriated", termTopicProbM.load, termTopicProbM );
    termTopicProbM.once( "loaded:filtered", termTopicMatrixView.load, termTopicMatrixView );
    termTopicProbM.once( "loaded:filtered", termFrequencyModel.load, termFrequencyModel );
    termFrequencyModel.once( "loaded:freqModel", termFrequencyView.load, termFrequencyView );
    stateModel.once("sending:colors", termTopicMatrixView.receiveSelectedTopics, termTopicMatrixView);

    // initialize all events that listen to stateModel
    stateModel.once( "loaded:states", function() {	
      termTopicProbM.listenTo(stateModel, "change:numAffinityTerms", termTopicProbM.update.bind( termTopicProbM ));
      termTopicProbM.listenTo(stateModel, "change:numSalientTerms", termTopicProbM.update.bind( termTopicProbM ));
      termTopicProbM.listenTo(stateModel, "change:visibleTerms", termTopicProbM.update.bind( termTopicProbM ));
      termTopicProbM.listenTo(stateModel, "change:addTopTwenty", termTopicProbM.update.bind( termTopicProbM ));
      
      foundTermsView.listenTo(   stateModel, 'change:foundTerms',   foundTermsView.render );
      unfoundTermsView.listenTo( stateModel, 'change:unfoundTerms', unfoundTermsView.render );
      
      termTopicMatrixView.listenTo(stateModel, "change:highlightedTerm", termTopicMatrixView.onSelectionTermChanged, termTopicMatrixView );
      termTopicMatrixView.listenTo(stateModel, "change:highlightedTopic", termTopicMatrixView.onSelectionTopicChanged, termTopicMatrixView );
      
      termFrequencyView.listenTo(stateModel, "change:highlightedTerm", termFrequencyView.onHighlightTermChanged, termFrequencyView);
      termFrequencyView.listenTo(stateModel, "change:highlightedTopic", termFrequencyView.onHighlightTopicChanged, termFrequencyView);
      
      termTopicMatrixView.listenTo( stateModel, "color:topic", termTopicMatrixView.clickTopic, termTopicMatrixView);
      termTopicProbM.listenTo( stateModel, "color:topic", termTopicProbM.selectTopic, termTopicProbM);
      termFrequencyModel.listenTo( stateModel, "color:topic", termFrequencyModel.selectTopic, termFrequencyModel);
      //sortDescription.listenTo( stateModel, "change:sortType change:doubleClickTopic" , sortDescription.render );
    });

    // initialize all events that listen to filtered model
    termTopicProbM.once( "loaded:filtered", function() {
      // Declare dependencies
      // data pipeline events
      termFrequencyModel.listenTo( termTopicProbM, "change:termIndex", termFrequencyModel.update.bind( termFrequencyModel ));
      termTopicMatrixView.listenTo( termTopicProbM, "change:sparseMatrix", termTopicMatrixView.update.bind( termTopicMatrixView ));
      totalTermsView.listenTo( termTopicProbM, 'change:termIndex', totalTermsView.render );
    
      // Once the matrix has loaded, need to set the top level div to a fixed size,
      // and then can set the inner one to be wider, which the scrollbar 
      $(".wrapper1").width($(".wrapper1").width());
      $(".div1").width($(".termTopicMatrixContainer").children().width());
    });

    // initialize all events that listen to term frequency model
    termFrequencyModel.once( "loaded:freqModel", function() {
      termFrequencyView.listenTo( termFrequencyModel, "change:topicalFreqMatrix", termFrequencyView.renderUpdate, termFrequencyView);
      termFrequencyView.listenTo( termFrequencyModel, "change:termIndex", termFrequencyView.renderUpdate.bind( termFrequencyView ));
    });

    // initialize user controls listeners that catch state model changes
    affinityNumTermsView.listenTo( stateModel, 'change:numAffinityTerms', affinityNumTermsView.render );
    salientNumTermsView.listenTo( stateModel, 'change:numSalientTerms', salientNumTermsView.render );
    totalTermsView.listenTo( stateModel, 'change:totalTerms', totalTermsView.render );

    // initialize state model listeners that catch view events
    stateModel.listenTo( termTopicMatrixView, "mouseover:topic mouseout:topic", stateModel.setHighlightedTopic );
    stateModel.listenTo( termTopicMatrixView, "mouseover:term mouseout:term", stateModel.setHighlightedTerm );
    stateModel.listenTo( termFrequencyView,   "mouseover:term mouseout:term", stateModel.setHighlightedTerm );

    //stateModel.listenTo( termTopicMatrixView, "doubleClick:topic", stateModel.setDoubleClickTopic );
    //stateModel.listenTo( termTopicMatrixView, "click:topic", stateModel.selectTopic );

    // http://backbonejs.org/#Events-listenTo: object.listenTo(other, event, callback)
    stateModel.listenTo( termTopicMatrixView, "click:topic", function(topicIndex) {
      console.log('[click:topic] topicIndex: '+topicIndex+', highlightedTopic: '+stateModel.get('highlightedTopic'));
      stateModel.selectTopic(topicIndex);
      //console.log( termTopicMatrixView.parentModel );
      // We could be clicking OFF a topic 
      if(stateModel.get('highlightedTopic') == topicIndex) {
        stateModel.setDoubleClickTopic(topicIndex);
        var topicLabel = termTopicMatrixView.parentModel.attributes.topicIndex[topicIndex];
        termiteMsgService.setTopic(ldaModel, topicIndex, topicLabel);
      }
    });
    // the loading process is complete?
    stateModel.loadStatesFromQueryString();
    initColorObjects(null);
  }
  
  $scope.getModels = function() {
    return {
      stateModel         : stateModel, 
      termTopicProbModel : termTopicProbM,
      termFrequencyModel : termFrequencyModel 
    };
  };

  // initialize parent and state model where needed
  //var basedir = '../data/';
  //var LdaModel = 'shakespeare-20';
  //var LdaModel = 'shakespeare-char-scene-20';
  $scope.LDAModels = [
    'shakespeare-char-scene-100',
    'shakespeare-char-scene-100-test',
    'shakespeare-50',
  ];
  $scope.LDAModel = $scope.LDAModels[1];
  $scope.changeModel = function() {
    console.log('$scope.LDAModel: '+$scope.LDAModel);
    //loadPage($scope.LDAModel);
    //var urlRoot = '/'+$scope.LDAModel;
    //$window.location.href = urlRoot;
    //console.log('$window.location.href: '+$window.location.href);
  };
  loadPage($scope.LDAModel);
   
});
</script>

</head>
<body ng-app="termiteTopicDisplay" !onLoad="onLoad()">
<div id="pageBackground" ng-controller="msgCtrl">
  <div id="pageFrame">

    <div id="pageHeader">
      <div id="pageControl" class="headerObject">
      <!--<div ng-include="'termite-hdr.html'" onLoad="onLoad()"></div>-->
    <table cellspacing="5">
    <tr>
      <td colspan="100%" style="vertical-align: top">
        <select name="LDAModel" ng-model="LDAModel"
          ng-options="m for m in LDAModels" 
          ng-change="changeModel()" style="width:200px">
        </select>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top">
        <div class="line">
            Currently showing 
            <div class="TotalTermsView" style="display:inline">25</div> 
            total terms.
        </div>
        <div class="line">
            Show top:
            <input class="AffinityNumTermsSlider" style="display:inline; width: 140px; vertical-align: -5px;" type="range" max="100" min="10" value="25"/> 
            <div class="AffinityNumTermsView" style="display:inline">25</div> 
            terms by affinity.</div>
        <div class="line">
            Show top:
            <input class="SalientNumTermsSlider" style="display:inline; width: 140px; vertical-align: -5px;" type="range" max="100" min="0" value="0"/>
            <div class="SalientNumTermsView" style="display:inline-block">0</div> 
            terms by saliency.
        </div>
      </td>
      
      <td style="vertical-align: top">
            <div class="line">
                Add top terms for clicked topics
                <input type="checkbox" class="TopTwentyAddition" style="display:inline-block"></div> 
            </div>
            <div class="line">
                Always showing terms: 
                <input class="UserDefinedTermsBox" style="display:inline; width: 200px; vertical-align: -2px" type="text"/>
                <div class="FoundTermsView" style="display:inline-block"></div>
            </div>
            <div class="line">
                <div class="UnfoundTermsPrefix" style="display:inline-block; visibility:hidden">Cannot find these terms: </div>
                <div class="UnfoundTermsView" style="display:inline-block; visibility:hidden"></div>
            </div>
        </td>
        <td style="vertical-align: top">
          <div class="line">
            <button type="button" class="clearAll" style="width: 150px">Clear all topic selections</button>
          </div>
          <div class="line">
            <button type="button" class="clearSort" style="width: 150px">Clear sorting method</button>
          </div>
          <!--<div class="line">
            <button type="button" style="width: 150px" ng-click="showTopicDetails=1">Show Topic Details</button>
          </div>-->
        </td>
      </tr>
    </table>

      </div>
    </div>

<style>
#.slide-out-div { padding:20px; height:800px; width:400px; background: #fff; border: 10px solid #666; }
.wrapper1, .wrapper2 { overflow-x:scroll; overflow-y:hidden; }
.wrapper1 { height: 20px; }
.div1     { width:100%; height:20px; }
.charText { color: #666; font-family: Verdana; font-size: 8pt;padding:10px 5px 10px; }
.popupDiv { width:40%; height:60%; position:absolute; 
  top:10%; left:30%; border:10px solid #eee; background: white; 
  overflow:auto; padding:0px 0px 0px; 
}

table { border:1px solid #ccc; border-collapse: collapse; width:100%; }
tbody td, tbody th { vertical-align:top; padding:2px 3px; }
thead th { padding:1px 6px 1px 3px; background:#fefefe; text-align:left; font-weight:normal; font-size:11px; border:1px solid #ddd; }
tbody th { width:12em; text-align:right; color:#666; padding-right:.5em; }
</style>

    <div id="pageContent" ng-controller="contentCtrl">
      <div style="vertical-align:top;height:800px;overflow-y:scroll;overflow-x:auto;">
      <table border=1 cellpadding=1 cellspacing=1 width="100%">
	    <tr>
	      <td style="width:600px;">
	        <!-- Main matrix -->
	        <div class="termTopicMatrixContainer"></div>
	      </td>
	      <td>
          <!-- Frequent terms -->
	        <div class="termFrequencyContainer"></div>
	      </td>
      </tr>
      </table>
      </div>

      <!-- Related documents -->
      <div my-draggable id="topicPopup" ng-show="showTopicDetails===1" class="popupDiv">
        <!--
        <div style="position:absolute;width:90%;padding:5px 30px 5px;">
          -div align="right">
            <button ng-click="showTopicDetails=0">Close</button>
          </div>
        </div-->

        <div style="height:30%;overflow-y:scroll;border:1px solid #ccc;">
          <span style="color: #666; font-family: Verdana; font-size: 8pt;">
            {{selectedTopic}}
          </span>
          <table border=1 cellpadding=1 cellspacing=0 width=250>
            <tr ng-repeat="doc in topDocsForTopic" style="color:#666; font-family:Verdana; font-size:8pt;">
              <td><a href="" ng-click="getDocContent(doc.char)">{{doc.char}}</a></td>
              <td>{{doc.score}}</td>
            </tr>
          </table>
        </div>
        <div style="height:70%;border:1px solid #ccc;">
          <div style="height:10%"> 
		        <div align="left" style="padding-top:10px;font-family: Verdana; font-size: 8pt;">
		          Topic Score:
		          <span ng-repeat="color in colorAxis.colors">
		            <span style="background-color:{{color}}">&gt;{{colorAxis.values[$index]}}</span>
		          </span>
		        </div>
		        <div style="padding:5px 10px 5px;">
		          <div align="top">{{docName}}</div>
		        </div>
	        </div>
	        <div style="overflow-y:scroll;height:90%">
	          <div ng-bind-html="docContent"></div>
	        </div>
	      </div>
	    </div>
	    
    </div> <!-- END PageContent, CONTROLLER: contentCtrl-->

	  <div id="pageDetails">
	    <p>This visualization shows the topical distribution of words in a corpus.</p>
	    <p>The area of a circle is proportional to a word's frequency in a topic.</p>
	  </div>

    <div id="pageFooter">
      Termite | Topic Model Visualization
      <br/>
      <span class="credits">
        Visualization by Jason Chuang, Ashley Jin, Stanford Vis Group
      </span>
      <br/>
      http://termite.stanford.edu | Version 1.1
    </div>
  </div>
</div>

</body>
</html>
