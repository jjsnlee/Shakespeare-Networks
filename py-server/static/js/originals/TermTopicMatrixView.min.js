var MATRIX_CONTAINER_PADDING={left_separation:8,top_separation:12,left:110,right:45,top:105,bottom:60,fullWidth:function(a){return this.left+this.right+MATRIX_ENCODING_PARAMETERS.packing()*a},fullHeight:function(a,b){return this.top+this.bottom+MATRIX_ENCODING_PARAMETERS.packing()*b}},MATRIX_ENCODING_PARAMETERS={NUM_TOPICS:0,NUM_TERMS:0,MATRIX:null,setNumTopics:function(a){this.NUM_TOPICS=a},setNumTerms:function(a){this.NUM_TERMS=a},setMatrix:function(a){this.MATRIX=a},DENSE_NUM_TOPICS:50,LOOSE_NUM_TOPICS:20,
DENSE_PACKING:12,LOOSE_PACKING:18,packing:function(){return 12},TARGET_PIXEL_DENSITY:0.2,radius:function(a,b,c,e){var d=0,f;for(f in a)d+=a[f].value*Math.PI;a=c*e*this.packing()*this.packing()*this.TARGET_PIXEL_DENSITY;d=Math.sqrt(a/d);c=0;for(f in b)c+=b[f].value*Math.PI;b=Math.sqrt(a/c);return{rs:d,nrs:b}}},TermTopicMatrixView=Backbone.View.extend({initialize:function(){this.sortDescriptionLayer=this.topLabelLayer=this.leftLabelLayer=this.leftLabelHighlightLayer=this.matrixLayer=this.matrixHighlightLayer=
this.yGridlineLayer=this.xGridlineLayer=this.bgHighlightLayer=this.svg=this.normRs=this.rs=this.ys=this.xs=this.stateModel=this.parentModel=null;this.colorCache=[];this.normalColor="normal";this.lastTransitionedTerm=this.highlightedTopic=this.highlightedTerm=null}});TermTopicMatrixView.prototype.initModel=function(a,b){this.parentModel=a;this.stateModel=b};
TermTopicMatrixView.prototype.load=function(){this.initialSelection();this.renderInit();this.renderUpdate();var a=_.groupBy(this.stateModel.get("topicIndex"),"selected")["true"];if(void 0!==a)for(var b=0;b<a.length;b++)this.selectTopic(a[b].id,a[b].color)};TermTopicMatrixView.prototype.initialSelection=function(){for(var a=this.stateModel.get("topicIndex"),b=0;b<a.length;b++)this.colorCache[b]=a[b].color};TermTopicMatrixView.prototype.colorMap=function(a){return a===DEFAULT?this.normalColor:a};
TermTopicMatrixView.prototype.renderInit=function(){var a=this.parentModel.get("sparseMatrix"),b=this.parentModel.get("normalizedSparseMatrix"),c=this.parentModel.get("termIndex"),e=this.stateModel.get("topicIndex");this.xs=d3.scale.linear();this.ys=d3.scale.linear();a=MATRIX_ENCODING_PARAMETERS.radius(a,b,e.length,c.length);this.rs=d3.scale.sqrt().domain([0,1]).range([0,a.rs]);this.normRs=d3.scale.sqrt().domain([0,1]).range([0,a.nrs]);this.svg=d3.select(this.el).append("svg:svg");this.initMatrixView();
this.initTopLabelView();this.initLeftLabelView()};
TermTopicMatrixView.prototype.renderUpdate=function(a){a=this.parentModel.get("termIndex");var b=this.stateModel.get("topicIndex");this.xs.domain([0,b.length]).range([MATRIX_CONTAINER_PADDING.left,MATRIX_CONTAINER_PADDING.left+b.length*MATRIX_ENCODING_PARAMETERS.packing()]);this.ys.domain([0,a.length]).range([MATRIX_CONTAINER_PADDING.top,MATRIX_CONTAINER_PADDING.top+a.length*MATRIX_ENCODING_PARAMETERS.packing()]);this.svg.style("width",MATRIX_CONTAINER_PADDING.fullWidth(b.length)+"px").style("height",
MATRIX_CONTAINER_PADDING.fullHeight(b.length,a.length)+"px");MAIN_WIDTH.TermTopicMatrixView=MATRIX_CONTAINER_PADDING.fullWidth(b.length);updateMainWidth();this.updateMatrixView();this.updateTopLabelView();this.updateLeftLabelView();this.transitionUserAddedTerm()};
TermTopicMatrixView.prototype.initMatrixView=function(){this.bgHighlightLayer=this.svg.append("svg:g").attr("class","bgHighlightLayer");this.xGridlineLayer=this.svg.append("svg:g").attr("class","xGridlineLayer");this.yGridlineLayer=this.svg.append("svg:g").attr("class","yGridlineLayer");this.matrixLayer=this.svg.append("svg:g").attr("class","matrixLayer");this.matrixHighlightLayer=this.svg.append("svg:g").attr("class","matrixHighlightLayer")};
TermTopicMatrixView.prototype.updateMatrixView=function(){var a=this.stateModel.get("normColumns"),b=this.parentModel.get("sparseMatrix"),c=this.parentModel.get("normalizedSparseMatrix"),e=this.parentModel.get("termIndex"),d=this.stateModel.get("topicIndex"),f=_.object(_.map(this.stateModel.get("topicIndex"),function(a){return[a.id,a]}));a&&(b=c);this.matrixLayer.selectAll("circle").data(b).exit().remove();this.matrixLayer.selectAll("circle").data(b).enter().append("svg:circle").on("mouseout",function(){this.trigger("mouseout:term",
"");this.trigger("mouseout:topic",null)}.bind(this));this.matrixLayer.selectAll("circle").data(b).attr("class",function(a){return["matrixElement",this.colorMap(f[a.topicIndex].color),getTopicClassTag(a.topicIndex.toString()),getTermClassTag(a.term)].join(" ")}.bind(this)).on("mouseover",function(a){this.trigger("mouseover:term",a.term);this.trigger("mouseover:topic",a.topicIndex)}.bind(this)).on("click",function(a){this.trigger("click:topic",a.topicIndex)}.bind(this)).attr("cx",function(a){return this.xs(f[a.topicIndex].position+
0.5)}.bind(this)).attr("cy",function(a){return this.ys(a.termIndex+0.5)}.bind(this)).attr("r",function(b){return a?this.normRs(b.value):this.rs(b.value)}.bind(this));this.matrixHighlightLayer.selectAll("circle").data(b).exit().remove();this.matrixHighlightLayer.selectAll("circle").data(b).enter().append("svg:circle");this.matrixHighlightLayer.selectAll("circle").data(b).attr("class",function(a){return["matrixHighlightElement",getTopicClassTag(a.topicIndex.toString()),getTermClassTag(a.term)].join(" ")}.bind(this)).attr("cx",
function(a){return this.xs(f[a.topicIndex].position+0.5)}.bind(this)).attr("pointer-events","none").attr("cy",function(a){return this.ys(a.termIndex+0.5)}.bind(this)).attr("r",function(b){return a?this.normRs(b.value):this.rs(b.value)}.bind(this)).attr("fill-opacity",0).attr("fill","red").attr("stroke-opacity",0).attr("stroke","red");this.bgHighlightLayer.selectAll("line").data(e).exit().remove();this.bgHighlightLayer.selectAll("line").data(e).enter().append("svg:line").attr("x1",this.xs(0)-MATRIX_CONTAINER_PADDING.left);
this.bgHighlightLayer.selectAll("line").data(e).attr("class",function(a){return["bgHighlightLayer",getTermClassTag(a)].join(" ")}.bind(this)).attr("x2",this.xs(d.length)).attr("y1",function(a,b){return this.ys(b+0.5)}.bind(this)).attr("y2",function(a,b){return this.ys(b+0.5)}.bind(this)).style("stroke","red").style("stroke-width","15px").style("stroke-opacity",0);this.xGridlineLayer.selectAll("line").data(e).exit().remove();this.xGridlineLayer.selectAll("line").data(e).enter().append("svg:line").attr("x1",
this.xs(0.5));this.xGridlineLayer.selectAll("line").data(e).attr("class",function(a){return["verticalLine",this.normalColor,getTermClassTag(a)].join(" ")}.bind(this)).attr("x2",this.xs(d.length-0.5)).attr("y1",function(a,b){return this.ys(b+0.5)}.bind(this)).attr("y2",function(a,b){return this.ys(b+0.5)}.bind(this));this.yGridlineLayer.selectAll("line").data(d).exit().remove();this.yGridlineLayer.selectAll("line").data(d).enter().append("svg:line").attr("y1",this.ys(0.5));this.yGridlineLayer.selectAll("line").data(d).attr("class",
function(a,b){return["verticalLine",this.colorMap(a.color),getTopicClassTag(a.id.toString())].join(" ")}.bind(this)).attr("x1",function(a,b){return this.xs(b+0.5)}.bind(this)).attr("x2",function(a,b){return this.xs(b+0.5)}.bind(this)).attr("y2",this.ys(e.length-0.5))};TermTopicMatrixView.prototype.initTopLabelView=function(){this.topLabelLayer=this.svg.append("svg:g").attr("class","topLabelLayer");this.sortDescriptionLayer=this.svg.append("svg:g").attr("class","sortDescriptionLayer")};
TermTopicMatrixView.prototype.updateTopLabelView=function(){var a=this.stateModel.get("topicIndex"),b=null;this.sortDescriptionLayer.selectAll("text").data(a).exit().remove();this.sortDescriptionLayer.selectAll("text").data(a).enter().append("svg:text").on("mouseout",function(){this.trigger("mouseout:topic",null)}.bind(this)).attr("y",10);this.sortDescriptionLayer.selectAll("text").data(a).attr("class",function(a,b){return["sortDescription",this.colorMap(a.color),getTopicClassTag(a.id.toString())].join(" ")}.bind(this)).on("mouseover",
function(a,b){this.trigger("mouseover:topic",a.id)}.bind(this)).attr("transform",function(a,b){return"translate("+this.xs(b)+","+(this.ys(0)-MATRIX_CONTAINER_PADDING.top_separation)+")"}.bind(this)).text(function(a,b){if(this.stateModel.get("doubleClickTopic")===a.id){if("asc"===this.stateModel.get("sortType"))return"\u2b06 ";if("desc"===this.stateModel.get("sortType"))return"\u2b07 "}}.bind(this));this.topLabelLayer.selectAll("text").data(a).exit().remove();this.topLabelLayer.selectAll("text").data(a).enter().append("svg:text").on("mouseout",
function(){this.trigger("mouseout:topic",null)}.bind(this)).attr("y",3);this.topLabelLayer.selectAll("text").data(a).attr("class",function(a,b){return["toplabel",this.colorMap(a.color),getTopicClassTag(a.id.toString())].join(" ")}.bind(this)).on("mouseover",function(a,b){this.trigger("mouseover:topic",a.id)}.bind(this)).attr("transform",function(a,b){return"translate("+this.xs(b+0.5)+","+(this.ys(0)-MATRIX_CONTAINER_PADDING.top_separation)+") rotate(295)"}.bind(this)).text(function(a,b){return a.name}).on("click",
function(a,d){b=setTimeout(function(){c(a,d)},200)}).on("dblclick",function(a,c){clearTimeout(b);b=null;this.trigger("doubleClick:topic",a.id)}.bind(this));var c=function(a,c){null!==b&&this.trigger("click:topic",a.id)}.bind(this)};TermTopicMatrixView.prototype.initLeftLabelView=function(){this.leftLabelLayer=this.svg.append("svg:g").attr("class","leftLabelLayer");this.leftLabelHighlightLayer=this.svg.append("svg:g").attr("class","leftLabelHighlightLayer")};
TermTopicMatrixView.prototype.updateLeftLabelView=function(){var a=this.parentModel.get("termIndex");this.leftLabelLayer.selectAll("text").data(a).exit().remove();this.leftLabelLayer.selectAll("text").data(a).enter().append("svg:text").on("mouseout",function(){this.trigger("mouseout:term","")}.bind(this)).attr("y",3);this.leftLabelLayer.selectAll("text").data(a).attr("class",function(a){return["leftLabel",this.normalColor,getTermClassTag(a)].join(" ")}.bind(this)).on("mouseover",function(a){this.trigger("mouseover:term",
a)}.bind(this)).attr("transform",function(a,c){return"translate("+(this.xs(0)-MATRIX_CONTAINER_PADDING.left_separation)+","+this.ys(c+0.5)+")"}.bind(this)).text(function(a){return a});this.leftLabelHighlightLayer.selectAll("text").data(a).exit().remove();this.leftLabelHighlightLayer.selectAll("text").data(a).enter().append("svg:text").attr("y",3);this.leftLabelHighlightLayer.selectAll("text").data(a).attr("class",function(a){return["leftHighlightLabel",getTermClassTag(a)].join(" ")}.bind(this)).attr("transform",
function(a,c){return"translate("+(this.xs(0)-MATRIX_CONTAINER_PADDING.left_separation)+","+this.ys(c+0.5)+")"}.bind(this)).text(function(a){return a}).style("pointer-events","none").style("fill","red").style("stroke-opacity",0).style("fill-opacity",0).style("text-anchor","end")};
TermTopicMatrixView.prototype.transitionUserAddedTerm=function(){var a=this.stateModel.getJustAddedTerm();null!==a&&this.lastTransitionedTerm!==a&&(this.matrixHighlightLayer.selectAll("."+getTermClassTag(a)).transition().duration(500).style("fill-opacity",0.5).style("stroke-opacity",0.5),this.bgHighlightLayer.selectAll("."+getTermClassTag(a)).transition().duration(500).style("stroke-opacity",0.3),this.leftLabelHighlightLayer.selectAll("."+getTermClassTag(a)).transition().duration(500).style("fill-opacity",
0.5),this.matrixHighlightLayer.selectAll("."+getTermClassTag(a)).transition().delay(2E3).duration(4E3).style("fill-opacity",0).style("stroke-opacity",0),this.bgHighlightLayer.selectAll("."+getTermClassTag(a)).transition().delay(500).duration(1E3).style("stroke-opacity",0),this.leftLabelHighlightLayer.selectAll("."+getTermClassTag(a)).transition().delay(2E3).duration(4E3).style("fill-opacity",0),this.lastTransitionedTerm=a)};TermTopicMatrixView.prototype.update=function(a){this.renderUpdate()};
TermTopicMatrixView.prototype.onSelectionTermChanged=function(a,b){""===b?this.unhighlight(!0,!1):this.highlight(b,null)};TermTopicMatrixView.prototype.onSelectionTopicChanged=function(a,b){null===b?this.unhighlight(!1,!0):this.highlight(null,b)};
TermTopicMatrixView.prototype.highlight=function(a,b){null!==a&&(this.highlightedTerm=a,this.svg.selectAll("."+getTermClassTag(a)).classed(HIGHLIGHT,!0));if(null!==b){var c=this.parentModel.get("termIndex"),e=this.parentModel.get("matrix");this.highlightedTopic=b;this.svg.selectAll("."+getTopicClassTag(b.toString())).classed(HIGHLIGHT,!0);for(var d=0;d<c.length;d++)a=c[d],e[d][b]>THRESHHOLD&&this.leftLabelLayer.selectAll("."+getTermClassTag(a)).classed(HIGHLIGHT,!0)}};
TermTopicMatrixView.prototype.unhighlight=function(a,b){a&&null!==this.highlightedTerm&&(this.svg.selectAll("."+getTermClassTag(this.highlightedTerm)).classed(HIGHLIGHT,!1),this.highlightedTerm=null);if(b&&null!==this.hightlightedTopic){var c=this.parentModel.get("termIndex"),e=this.parentModel.get("matrix"),d=this.highlightedTopic;this.svg.selectAll("."+getTopicClassTag(d.toString())).classed(HIGHLIGHT,!1);for(var f=0;f<c.length;f++)a=c[f],e[f][d]>THRESHHOLD&&this.leftLabelLayer.selectAll("."+getTermClassTag(a)).classed(HIGHLIGHT,
!1);this.highlightedTopic=null}};var somethingsomething=null;TermTopicMatrixView.prototype.updateColors=function(a){somethingsomething=a;if(void 0!==a&&null!==a)if(void 0!==a.changed&&null!==a.changed&&void 0!==a.changed.topicIndex){if(a=_.groupBy(this.stateModel.get("topicIndex"),"selected")["true"],void 0!==a)for(var b=0;b<a.length;b++)this.selectTopic(a[b].id,a[b].color)}else void 0!==a.topic&&this.selectTopic(a.topic,a.color)};
TermTopicMatrixView.prototype.selectTopic=function(a,b){if(null!==a){b===DEFAULT&&(b=this.normalColor);var c=this.colorCache[a];this.svg.selectAll("."+getTopicClassTag(a.toString())).classed(c,!1).classed(b,!0);this.colorCache[a]=b}};
