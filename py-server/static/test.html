<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Termite | Topic Model Visualization</title>
	<link href="css/termite.css" rel="stylesheet" type="text/css"/>
	
	<link href="css/InteractionObjects.css" rel="stylesheet" type="text/css"/>
	<link href="css/chosen.css" rel="stylesheet" type="text/css"/>
	<script type="text/javascript" src="d3.v3.min.js"></script>
<script type="text/javascript">
var progressDots = 3;
var progressHandler = null;
var clearLoadingTermTopicMatrix = function() {
	if ( progressHandler !== null ) {
		clearTimeout( progressHandler );
	}
	d3.select(".ProgressTermTopicMatrix").remove();
};
var clearLoadingTermFrequency = function() {
	if ( progressHandler !== null ) {
		clearTimeout( progressHandler );
	}
	d3.select(".ProgressTermFrequency").remove();
};
var tickLoadingProgress = function() {
	progressDots = (progressDots%10)+1;
	var stringDots = "Please wait";
	for ( var i = 0; i < progressDots; i++ ) {
		stringDots += " .";
	}
	d3.selectAll(".ProgressDots").text(stringDots);
	setTimeout( tickLoadingProgress, 400 );
};
tickLoadingProgress();
</script>
<script>
// research account
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-8338361-3', 'chuang.ca');
  ga('send', 'pageview');
// research account
</script>
	<script type="text/javascript" src="lib/jquery.min.js"></script>
	<script type="text/javascript" src="lib/underscore.min.js"></script>
	<script type="text/javascript" src="lib/backbone.min.js"></script>
	<script type="text/javascript" src="lib/chosen.jquery.min.js"></script>
	<script type="text/javascript" src="lib/jquery-ui.min.js"></script>
	
	<!-- This is blank -->
	<script type="text/javascript" src="js/FullTermTopicProbabilityModel.min.js"></script>

	<script type="text/javascript" src="js/SeriatedTermTopicProbabilityModel.js"></script>
	<script type="text/javascript" src="js/FilteredTermTopicProbabilityModel.js"></script>
	<script type="text/javascript" src="js/TermFrequencyModel.js"></script>

	<script type="text/javascript" src="js/ViewParameters.min.js"></script>
	
	<script type="text/javascript" src="js/TermTopicMatrixView.min.js"></script>
	<script type="text/javascript" src="js/TermFrequencyView.js"></script>

	<script type="text/javascript" src="js/UserControlViews.min.js"></script>
	<script type="text/javascript" src="js/StateModel.js"></script>
	
	<script type="text/javascript" src="lib/html5slider.min.js"></script>
	<script type="text/javascript" src="js/QueryString.min.js"></script>
<script type="text/javascript">

/**
 * Generates a descending sorted sparse matrix representation of a full matrix. 
 * Must be called by a model that has termIndex, topicIndex, and matrix default vars
 * (e.g. seriated model, filtered model)
 *
 * @this { a termTopic model }
 * @param { double } THRESHHOLD is defined in ViewParameters
 * @param { array } termIndex is a list of ordered terms, size n
 * @param { array } topicIndex is a list of ordered topics, size m
 * @param { 2D array } matrix is a n x m matrix of doubles
 * @param { array } cSums, non-null if normalizing columns
 * @return { array } Sparse matrix representation of matrix (list of objects)
 */
var generateSparseMatrix = function( cSums ) {
	var THRESHHOLD = 0.01;
	var termIndex = this.get("termIndex");
	var topicIndex = this.get("topicIndex");	// what about this global?
	var matrix = this.get("matrix");
	
	var columnSums = cSums;
	if( cSums === null){
		columnSums = [];
		for(var i = 0; i < topicIndex.length; i++){
			columnSums.push(1);
		}
	} 
	
	var sparseMatrix = [];
	for ( var i = 0; i < termIndex.length; i++ )
		for ( var j = 0; j < topicIndex.length; j++ )
			if ( matrix[i][j] > THRESHHOLD )
				sparseMatrix.push({
					'term' : termIndex[i],
					'termIndex' : i,
					'topicName' : topicIndex[j],
					'topicIndex' : j,
					'value' : matrix[i][j] / columnSums[j]
				});
	sparseMatrix = sparseMatrix.sort( function(a,b) { return b.value - a.value } );
	return sparseMatrix;
};
/**
 * Returns a column-first representation of a row-first matrix
 * 
 * @this { index.html }
 * @param { 2D array } row first matrix
 * @return { 2D array } column first matrix
 */
var generateColumnFirst = function( matrix ) {
	//var matrix = this.get("matrix");
	var colMatrix = [];
	if(matrix === null)
		return null;
	// init empty rows of column matrix
	for (i = 0; i < matrix[0].length; ++i) {
		colMatrix.push([]);
	}
	// fill in values
	for (i = 0; i < matrix.length; ++i) {
    	var row = matrix[i];
    	for (j = 0; j < row.length; ++j) {
        	colMatrix[j].push(row[j]);
        }
    }
    return colMatrix;
};
// temp globals to check values with javascript console
var stateModel;
var seriatedTermTopicProbabilityModel;
var filteredTermTopicProbabilityModel;
var termTopicMatrixView;
var termFrequencyModel;
var termFrequencyView;
$(document).ready( function()
{
	// create backbone models and views
	stateModel = new StateModel();
	
	seriatedTermTopicProbabilityModel = new SeriatedTermTopicProbabilityModel();
	filteredTermTopicProbabilityModel = new FilteredTermTopicProbabilityModel();
	termFrequencyModel = new TermFrequencyModel();
	
	termTopicMatrixView = new TermTopicMatrixView( {el: "div.termTopicMatrixContainer"} );
	termFrequencyView = new TermFrequencyView( {el: "div.termFrequencyContainer"} );
	
	// init user control views
	var totalTermsView = new TotalTermsView( {model: stateModel} );
	var affinityNumTermsView = new AffinityNumTermsView( {model: stateModel} );
	var salientNumTermsView = new SalientNumTermsView( {model: stateModel} );
	var affinityNumTermsSlider = new AffinityNumTermsSlider( {model: stateModel} );
	var salientNumTermsSlider = new SalientNumTermsSlider( {model: stateModel} );
	var addTopTwenty = new AddTopTwenty( {model:stateModel} );
	var sortDescription = new SortDescription( {model:stateModel} );
	var clearAllButton = new ClearAllButton( {model:stateModel} );
	var clearSortButton = new ClearSortButton( {model:stateModel} );
	var normalizeColumns = new NormalizeColumns( {model:stateModel });
	var saveStateButton = new SaveStateButton( {model:stateModel} );
	var loadStateButton = new LoadStateButton( {model:stateModel} );
	var currentVersionNo = new CurrentVersionNo( {model:stateModel} );
	var multiSelectTermsBox = new MultiSelectTermsBox( {model:stateModel} );
	
	// topic labelling/reposition stuff
	var topicMoveButton = new TopicMoveButton( {model:stateModel} );
	var clearMoveButton = new ClearMoveButton( {model:stateModel} );
	var topicRenameButton = new TopicRenameButton( {model:stateModel} );
	
	var showInstructionsButton = new ShowInstructionsButton( {model:stateModel} );
	
	// initialize parent and state model where needed
	//seriatedTermTopicProbabilityModel.initModel( fullModel );	// unused at the moment
	filteredTermTopicProbabilityModel.initModel( seriatedTermTopicProbabilityModel, stateModel );
	termTopicMatrixView.initModel( filteredTermTopicProbabilityModel, stateModel );
	termFrequencyModel.initModels( filteredTermTopicProbabilityModel, stateModel );
	termFrequencyView.initModel( termFrequencyModel, stateModel );
	
	// load all models
	stateModel.once( "loaded:states", seriatedTermTopicProbabilityModel.load, seriatedTermTopicProbabilityModel );
	seriatedTermTopicProbabilityModel.once( "loaded:seriated", filteredTermTopicProbabilityModel.load, filteredTermTopicProbabilityModel );
	filteredTermTopicProbabilityModel.once( "loaded:filtered", clearLoadingTermTopicMatrix ); //?
	filteredTermTopicProbabilityModel.once( "loaded:filtered", termTopicMatrixView.load, termTopicMatrixView );
	filteredTermTopicProbabilityModel.once( "loaded:filtered", termFrequencyModel.load, termFrequencyModel );
	termFrequencyModel.once( "loaded:freqModel", clearLoadingTermFrequency ); //?
	termFrequencyModel.once( "loaded:freqModel", termFrequencyView.load, termFrequencyView );
	
	// initialize all events that listen to stateModel
	stateModel.once( "loaded:states", function() {
		// chosen multi-select stuff
		$(".chzn-select").chosen();
		
		filteredTermTopicProbabilityModel.listenTo(stateModel, "change:numAffinityTerms", filteredTermTopicProbabilityModel.update.bind( filteredTermTopicProbabilityModel ));
		filteredTermTopicProbabilityModel.listenTo(stateModel, "change:numSalientTerms", filteredTermTopicProbabilityModel.update.bind( filteredTermTopicProbabilityModel ));
		filteredTermTopicProbabilityModel.listenTo(stateModel, "change:visibleTerms", filteredTermTopicProbabilityModel.update.bind( filteredTermTopicProbabilityModel ));
		filteredTermTopicProbabilityModel.listenTo(stateModel, "change:sortType change:doubleClickTopic", filteredTermTopicProbabilityModel.update.bind( filteredTermTopicProbabilityModel));
		filteredTermTopicProbabilityModel.listenTo(stateModel, "change:addTopTwenty", filteredTermTopicProbabilityModel.update.bind( filteredTermTopicProbabilityModel ));
		filteredTermTopicProbabilityModel.listenTo(stateModel, "change:topicIndex color:topic", filteredTermTopicProbabilityModel.update, filteredTermTopicProbabilityModel );

		termTopicMatrixView.listenTo(stateModel, "change:highlightedTerm", termTopicMatrixView.onSelectionTermChanged, termTopicMatrixView );
		termTopicMatrixView.listenTo(stateModel, "change:highlightedTopic", termTopicMatrixView.onSelectionTopicChanged, termTopicMatrixView );
		termTopicMatrixView.listenTo(stateModel, "change:topicIndex color:topic", termTopicMatrixView.updateColors, termTopicMatrixView);
		termTopicMatrixView.listenTo(stateModel, "change:topicIndex", termTopicMatrixView.update, termTopicMatrixView);
		termTopicMatrixView.listenTo(stateModel, "change:topicLabels change:topicPosition", termTopicMatrixView.update.bind( termTopicMatrixView ));
		termTopicMatrixView.listenTo( stateModel, "change:normColumns", termTopicMatrixView.update, termTopicMatrixView);

		termFrequencyModel.listenTo(stateModel, "color:topic", termFrequencyModel.update.bind( termFrequencyModel ));
		termFrequencyModel.listenTo(stateModel, "change:topicPosition change:topicIndex", termFrequencyModel.update.bind( termFrequencyModel ));

		termFrequencyView.listenTo(stateModel, "change:highlightedTerm", termFrequencyView.onHighlightTermChanged, termFrequencyView);
		termFrequencyView.listenTo(stateModel, "change:highlightedTopic", termFrequencyView.onHighlightTopicChanged, termFrequencyView);
		
		updateMainWidth();
	});
	
	// initialize all events that listen to filtered model
	filteredTermTopicProbabilityModel.once( "loaded:filtered", function() {
		// Declare dependencies
		// data pipeline events
		termTopicMatrixView.listenTo( filteredTermTopicProbabilityModel, "change:sparseMatrix", termTopicMatrixView.update.bind( termTopicMatrixView ));
		termFrequencyModel.listenTo( filteredTermTopicProbabilityModel, "change:termIndex", termFrequencyModel.update.bind( termFrequencyModel ));

		// user control views
		totalTermsView.listenTo( filteredTermTopicProbabilityModel, 'change:termIndex', totalTermsView.render );
	});
	
	// initialize all events that listen to term frequency model
	termFrequencyModel.once( "loaded:freqModel", function() {
		termFrequencyView.listenTo( termFrequencyModel, "updated:TFM", termFrequencyView.renderUpdate, termFrequencyView);
	});
	
	// user control views
	sortDescription.listenTo( stateModel, "change:sortType change:doubleClickTopic" , sortDescription.render );
	multiSelectTermsBox.listenTo( stateModel, 'change:visibleTerms', multiSelectTermsBox.render );
	topicRenameButton.listenTo( stateModel, 'color:topic', topicRenameButton.render );
	topicRenameButton.listenTo( stateModel, 'clear:allTopics', topicRenameButton.clear );
	affinityNumTermsView.listenTo( stateModel, 'change:numAffinityTerms', affinityNumTermsView.render );
	salientNumTermsView.listenTo( stateModel, 'change:numSalientTerms', salientNumTermsView.render );
	totalTermsView.listenTo( stateModel, 'change:totalTerms', totalTermsView.render );
	currentVersionNo.listenTo( stateModel, 'change:version', currentVersionNo.render );
	multiSelectTermsBox.listenTo( seriatedTermTopicProbabilityModel, 'loaded:seriated', multiSelectTermsBox.render );

	// initialize state model listeners that catch view events
	stateModel.listenTo( termTopicMatrixView, "mouseover:topic mouseout:topic", stateModel.setHighlightedTopic );
	stateModel.listenTo( termTopicMatrixView, "mouseover:term mouseout:term", stateModel.setHighlightedTerm );
	stateModel.listenTo( termFrequencyView, "mouseover:term mouseout:term", stateModel.setHighlightedTerm );
	stateModel.listenTo( termTopicMatrixView, "doubleClick:topic", stateModel.setDoubleClickTopic );	
	stateModel.listenTo( termTopicMatrixView, "click:topic", stateModel.selectTopic );
	stateModel.listenTo( stateModel, "change:topicIndex", stateModel.batchClaimColors, stateModel );
	
	eventData = null;
	$('#multi-select').chosen().change(
		function(event, data){ multiSelectTermsBox.trigger("change"); });

	// begin loading process
	loadStatefromDB( true );
});
var MAIN_WIDTH = { 'Controls' : 400, 'TermTopicMatrixView' : 0, 'TermFrequencyView' : 0 };
var updateMainWidth = function()
{
	var mainWidth = ( MAIN_WIDTH.Controls + MAIN_WIDTH.TermTopicMatrixView + MAIN_WIDTH.TermFrequencyView );
	d3.select( "table.mainPanels" ).style( "width", mainWidth + "px" );
}
</script>
</head>
<body>
<div class="pageBackground">
	<div class="pageFrame">
		<div class="pageMainContainer">
			<table class="mainPanels">
				<tr>
					<td class="mainLeftPanel">
						<div class="pageLogo" style="line-height: 12px">
							<span class="title" style="line-height: 30px">Termite</span><span class="subtitle"> | Topic Model Visualization</span><br/>
							<span class="credits">Developed by <a href='http://jason.chuang.ca' target='_blank'>Jason Chuang</a> &amp; <a href="http://www.linkedin.com/in/ashpjin" target="_blank">Ashley Jin</a><br/><a href='http://vis.stanford.edu' target='_blank'>Stanford Vis Group</a> &amp; <a href="http://idl.cs.washington.edu">UW Interactive Data Lab</a></span><br/>
						</div>
						<div class="pageControl">
								<div class="controlOption" style="display: none">
									<div class="currentVersion" style="display:inline-block">Current Version No. </div>
									<div class="currentVersionNo" style="display:inline-block">0</div>
								</div>
								<br/>
								<div class="controlOption">
									Currently showing 
									<div class="TotalTermsView" style="display:inline">50</div> 
									total terms.
								</div>
								<div class="controlOption">
									Display <div class="AffinityNumTermsView" style="display:inline">50</div> 
									terms by affinity:<br/>
									<input class="AffinityNumTermsSlider" style="display:inline; width: 240px; vertical-align: -5px;" type="range" max="100" min="10" value="50"/> 
								</div>
								<div class="controlOption">
									Display top <div class="SalientNumTermsView" style="display:inline-block">0</div> 
									terms by saliency:<br/>
									<input class="SalientNumTermsSlider" style="display:inline; width: 240px; vertical-align: -5px;" type="range" max="100" min="0" value="0"/>
								</div>
								<br/>
								<div class="controlOption controlInstruction">Double click topic label to sort by topic.</div>
								<div class="controlOption">
									Sorting by: 
									<div class="SortDescription" style="display:inline-block">default</div> 
								</div>
								<div class="controlOption">
									<button type="button" class="clearSort" style="width: 140px">Clear sorting method</button>
								</div>
								<br/>
								<div class="controlOption controlInstruction">Choose terms to always show in the terms list.</div>
								<div class="controlOption">
									 <div>
										Always display the following terms:
										<select id="multi-select" data-placeholder="Choose Terms..." style="width:300px;" multiple class="chzn-select multiSelectTerms" tabindex="8">
										</select>
									  </div>
								</div>
								<br/>
								<div class="controlOption">
									<input type="checkbox" class="NormalizeColumns" style="display:inline-block"></input> 
			 						 Normalize by topic weight
								</div>									
								<div class="controlOption">
									<input type="checkbox" class="TopTwentyAddition" style="display:inline-block"></input> 
									 Add 20 top terms per selected topic
								</div>
								<br/>
								<div class="controlOption controlInstruction">Click a topic label to rename it.</div>
								<div class="controlOption">
									Relabel: 
									<input class="rename" style="display:inline; width: 100px; vertical-align: -2px" type="text"/>
									<button type="button" class="saveRename" style="width: 90px">Save Label</button>
								</div>
								<br/>
								<div class="controlOption">
									<button type="button" class="clearAll" style="width: 160px">Clear all topic selections</button>
								</div>
								<br/>
							<div class="controlOption">
								Move topic at 
								<input class="moveTopicNo" style="display:inline; width: 50px; vertical-align: -2px" type="text"/>
								to: 
								<input class="topicPosition" style="display:inline; width: 150px; vertical-align: -2px" type="text"/>
								<button type="button" class="saveMove" style="width: 80px">Save Move</button>
								<button type="button" class="clearMoves" style="width: 120px">Clear All Moves</button>
							</div>
							<div class="controlOption">
								<button type="button" class="showInstructions" style="width: 120px">Show Instructions</button>	
							</div>
							<div class="controlOption">
								<p>This visualization shows the topical distribution of words in a corpus. The area of a circle is proportional to a word's frequency in a topic.</p>
							</div>
						</div>
					</td>
					<td class="mainRightPanel">
						<div class="termTopicMatrixContainer"><div class="ProgressTermTopicMatrix" style="width: 140px; margin: 160px 60px; padding: 20px; vertical-align: middle; text-align: left; font-family: Georgia; background: #ccc; border: 1px solid #999"><div>Term-topic matrix</div><div style="color: #666; font-size: 0.8em">Downloading data</div><div class="ProgressDots" style="color: #666; font-size: 0.8em">Please wait . . .</div></div></div>
					</td>
					<td class="mainRightPanel">
						<div class="termFrequencyContainer"><div class="ProgressTermFrequency" style="width: 140px; margin: 160px 60px; padding: 20px; vertical-align: middle; text-align: left; font-family: Georgia; background: #ccc; border: 1px solid #999"><div>Term frequencies</div><div style="color: #666; font-size: 0.8em">Downloading data</div><div class="ProgressDots" style="color: #666; font-size: 0.8em">Please wait . . .</div></div></div>
					</td>
				</tr>
			</table>
		</div>
		<div class="pageFooterContainer">
			<div class="pageFooter" style="display: block"><a href="http://github.com/uwdata/termite-data-server">Termite Data Server</a> | <a href="http://github.com/uwdata/termite-visualizations">Termite Visualizations</a> | <a href="http://jason.chuang.ca">jason.chuang.ca</a></div>
		</div>
	</div>
</div>
</body>
</html>

<!--
<script type='text/javascript' src='http://www.findtheconversation.com/wp-includes/js/jquery/jquery.js?ver=1.8.3'></script>
<script type='text/javascript' src='http://www.findtheconversation.com/wp-content/plugins/jquery-collapse-o-matic/collapse.min.js?ver=1.4.9'></script>
<script type='text/javascript' src='http://www.findtheconversation.com/wp-includes/js/comment-reply.min.js?ver=3.5.2'></script>
<script type='text/javascript' src='http://www.findtheconversation.com/wp-content/plugins/media-element-html5-video-and-audio-player/mediaelement/mediaelement-and-player.min.js?ver=2.7.0'></script>
<div id="graph"></div>
<div id="graph-info"></div>
<script src="http://www.findtheconversation.com/wp-content/themes/conversation_theme/d3.v3.min.js"></script>
<script src="http://www.findtheconversation.com/wp-content/themes/conversation_theme/conversation.min.js"></script>
-->
